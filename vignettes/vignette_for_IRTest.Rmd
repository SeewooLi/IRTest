---
title: "IRT without the normality assumption"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{IRT without the normality assumption}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
fontsize: 12pt
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(IRTest)
library(ggplot2)
library(gridExtra)
```

# 0. Introduction 

+ **IRTest** is a useful tool for $\mathcal{\color{red}{IRT}}$ (item response theory) parameter $\mathcal{\color{red}{est}}$imation, especially when the violation of normality assumption on latent distribution is suspected.

+ **IRTest** deals with uni-dimensional latent variable.

+ For missing values, **IRTest** adopts full information maximum likelihood (FIML) approach.

+ In **IRTest**, including the conventional usage of Gaussian distribution, several methods are available for estimation of latent distribution:
    + empirical histogram method,
    + two-component Gaussian mixture distribution,
    + Davidian curve,
    + kernel density estimation,    
    + log-linear smoothing.

## Installation

The CRAN version of **IRTest** can be installed on R-console with:

```
install.packages("IRTest")
```

For the development version, it can be installed on R-console with:
```
devtools::install_github("SeewooLi/IRTest")
```

## Functions

Followings are the functions of **IRTest**.

  + `IRTest_Dich` is the estimation function when all items are *dichotomously* scored.
  
  + `IRTest_Poly` is the estimation function when all items are *polytomously* scored.
  
  + `IRTest_Mix` is the estimation function for *a mixed-format test*, a test comprising both dichotomous item(s) and polytomous item(s).
  
  + `item_fit` tests the statistical fit of all items individually.
  
  + `inform_f_item` calculates the information value(s) of an item.

  + `inform_f_test` calculates the information value(s) of a test.
    
  + `plot_item` draws item response function(s) of an item.
  
  + `reliability` calculates marginal reliability coefficient of IRT.
  
  + `latent_distribution` returns evaluated PDF value(s) of an estimated latent distribution.

  + `DataGeneration` generates several objects that can be useful for computer simulation studies. Among these are simulated item parameters, ability parameters and the corresponding item-response data.
  
  + `dist2` is a probability density function of two-component Gaussian mixture distribution.
  
  + `original_par_2GM` converts re-parameterized parameters of two-component Gaussian mixture distribution into original parameters.  
  
  + `cat_clps` recommends category collapsing based on item parameters (or, equivalently, item response functions).
  
  + `recategorize` implements the category collapsing.


\
\
\

# 1. Dichotomous items

+ **Preparing data**

The function `DataGeneration` can be used in a preparation step.
This function returns a set of artificial data and the true parameters underlying the data.

```{r}
Alldata <- DataGeneration(seed = 123456789,
                          model_D = rep(1:2, each=5),
                          N=1000,
                          nitem_D = 10,
                          nitem_P = 0,
                          latent_dist = "2NM",
                          d = 1.664,
                          sd_ratio = 2,
                          prob = 0.3)

data <- Alldata$data_D
theta <- Alldata$theta
data[1:500, 1] <- NA
data[501:1000, 2] <- NA
colnames(data) <- paste0("item", 1:10)
```


\
\
\

+ **Analysis** (parameter estimation)

```{r, results='hide', message=FALSE}
Mod1 <- IRTest_Dich(data = data,
                    model = 2,
                    latent_dist = "LLS",
                    h=4)
```

\
\
\

+ **Results**

```{r, fig.align='center', fig.height=6, fig.width=6}
### Summary
summary(Mod1)

### The estimated item parameters
Mod1$par_est

### The asymptotic standard errors of item parameters
Mod1$se

### The estimated ability parameters
plot(theta, Mod1$theta)
abline(b=1, a=0)
```


* The result of latent distribution estimation

```{r, fig.align='center', fig.asp=.6, fig.width=6}
plot(Mod1, mapping = aes(colour="Estimated"), linewidth = 1) +
  lims(
    y = c(0, .75)
  )+
  geom_line(
    mapping=aes(
      x=seq(-6,6,length=121), 
      y=dist2(
        seq(-6,6,length=121),
        prob = .3, 
        d=1.664, 
        sd_ratio = 2
        ), 
      colour="True"),
    linewidth = 1)+
  labs(
    title="The estimated latent density using '2NM'", colour= "Type"
    )+
  theme_bw()
```

* Item response function

```{r, fig.align='center', fig.asp=0.8, fig.width=6}
p1 <- plot_item(Mod1,1)
p2 <- plot_item(Mod1,4)
p3 <- plot_item(Mod1,8)
p4 <- plot_item(Mod1,10)
grid.arrange(p1, p2, p3, p4, ncol=2, nrow=2)
```


+ **Item fit**
```{r}
item_fit(Mod1)
```

* Reliability

```{r}
reliability(Mod1)
```

* Posterior distributions for the examinees

Each examinee's posterior distribution is identified in the E-step of the estimation algorithm (i.e., EM algorithm).
Posterior distributions can be found in `Mod1$Pk`.

```{r, fig.align='center', fig.asp=.7, fig.width=6}
set.seed(1)
selected_examinees <- sample(1:1000,6)
post_sample <- 
  data.frame(
    X = rep(seq(-6,6, length.out=121),6), 
    prior = rep(Mod1$Ak/(Mod1$quad[2]-Mod1$quad[1]), 6),
    posterior = 10*c(t(Mod1$Pk[selected_examinees,])), 
    ID = rep(paste("examinee", selected_examinees), each=121)
    )

ggplot(data=post_sample, mapping=aes(x=X))+
  geom_line(mapping=aes(y=posterior, group=ID, color='Posterior'))+
  geom_line(mapping=aes(y=prior, group=ID, color='Prior'))+
  labs(title="Posterior densities for selected examinees", x=expression(theta), y='density')+
  facet_wrap(~ID, ncol=2)+
  theme_bw()
```

* Test information function

```{r, fig.align='center', fig.asp=.8, fig.width=6}
ggplot()+
  stat_function(
    fun = inform_f_test,
    args = list(Mod1)
  )+ 
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est, 1, "d"),
    mapping = aes(color="Item 1")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est, 2, "d"),
    mapping = aes(color="Item 2")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est, 3, "d"),
    mapping = aes(color="Item 3")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est, 4, "d"),
    mapping = aes(color="Item 4")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est, 5, "d"),
    mapping = aes(color="Item 5")
  )+
  lims(x=c(-6,6))+
  labs(title="Test information function", x=expression(theta), y='information')+
  theme_bw()
```


----------

\break

# 2. Polytomous items

+ **Preparing data**


```{r}
Alldata <- DataGeneration(seed = 123456789,
                          model_P = "GPCM",
                          categ = rep(c(3,7), each = 5),
                          N=1000,
                          nitem_D = 0,
                          nitem_P = 10,
                          latent_dist = "2NM",
                          d = 1.414,
                          sd_ratio = 2,
                          prob = 0.5,
                          s=.5,
                          b_sd = .5)

data <- Alldata$data_P
theta <- Alldata$theta
data[1:500, 1:3] <- NA
data[501:1000, 4:6] <- NA
colnames(data) <- paste0("item", 1:10)
```

\
\

+ **Analysis** (parameter estimation)

```{r, results='hide', message=FALSE}
Mod1 <- IRTest_Poly(data = data,
                    model = "GPCM",
                    latent_dist = "KDE")
```

\
\
\

+ **Results**

```{r, fig.align='center', fig.height=6, fig.width=6}
### Summary
summary(Mod1)

### The estimated item parameters
Mod1$par_est

### The asymptotic standard errors of item parameters
Mod1$se

### The estimated ability parameters
plot(theta, Mod1$theta)
abline(b=2, a=0)
```

* The result of latent distribution estimation

```{r, fig.align='center', fig.asp=.6, fig.width=6}
plot(Mod1, mapping = aes(colour="Estimated"), linewidth = 1) +
  lims(
    y = c(0, .75)
  )+
  geom_line(
    mapping=aes(
      x=seq(-6,6,length=121), 
      y=dist2(
        seq(-6,6,length=121),
        prob = .3, 
        d=1.664, 
        sd_ratio = 2
        ), 
      colour="True"),
    linewidth = 1)+
  labs(
    title="The estimated latent density using '2NM'", colour= "Type"
    )+
  theme_bw()
```

* Item response function

```{r, fig.align='center', fig.asp=0.8, fig.width=6}
p1 <- plot_item(Mod1,1)
p2 <- plot_item(Mod1,4)
p3 <- plot_item(Mod1,8)
p4 <- plot_item(Mod1,10)
grid.arrange(p1, p2, p3, p4, ncol=2, nrow=2)
```


+ **Item fit**
```{r}
item_fit(Mod1)
```

* Reliability

```{r}
reliability(Mod1)
```

* Posterior distributions for the examinees

Each examinee's posterior distribution is identified in the E-step of the estimation algorithm (i.e., EM algorithm).
Posterior distributions can be found in `Mod1$Pk`.

```{r, fig.align='center', fig.asp=.7, fig.width=6}
set.seed(1)
selected_examinees <- sample(1:1000,6)
post_sample <- 
  data.frame(
    X = rep(seq(-6,6, length.out=121),6), 
    prior = rep(Mod1$Ak/(Mod1$quad[2]-Mod1$quad[1]), 6),
    posterior = 10*c(t(Mod1$Pk[selected_examinees,])), 
    ID = rep(paste("examinee", selected_examinees), each=121)
    )

ggplot(data=post_sample, mapping=aes(x=X))+
  geom_line(mapping=aes(y=posterior, group=ID, color='Posterior'))+
  geom_line(mapping=aes(y=prior, group=ID, color='Prior'))+
  labs(title="Posterior densities for selected examinees", x=expression(theta), y='density')+
  facet_wrap(~ID, ncol=2)+
  theme_bw()
```

* Test information function

```{r, fig.align='center', fig.asp=.8, fig.width=6}
ggplot()+
  stat_function(
    fun = inform_f_test,
    args = list(Mod1)
  )+ 
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est, 1, "p"),
    mapping = aes(color="Item 1 (3 cats)")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est, 2, "p"),
    mapping = aes(color="Item 2 (3 cats)")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est, 3, "p"),
    mapping = aes(color="Item 3 (3 cats)")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est, 8, "p"),
    mapping = aes(color="Item 8 (7 cats)")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est, 9, "p"),
    mapping = aes(color="Item 9 (7 cats)")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est, 10, "p"),
    mapping = aes(color="Item 10 (7 cats)")
  )+
  lims(x=c(-6,6))+
  labs(title="Test information function", x=expression(theta), y='information')+
  theme_bw()
```


----------

\break

# 3. Mixed-format test

+ **Preparing data**

As in the cases of dichotomous and polytomous items, the function `DataGeneration` can be used in the preparation step.
This function returns artificial data and some useful objects for analysis (i.e., `theta`, `data_D`, `item_D`, `data_P`, & `item_P`).


```{r}
Alldata <- DataGeneration(seed = 12345678,
                          model_D = rep(2,10),
                          model_P = "GPCM",
                          categ = rep(5,5),
                          N=1000,
                          nitem_D = 10,
                          nitem_P = 5,
                          latent_dist = "2NM",
                          d = 1.664,
                          sd_ratio = 1,
                          prob = 0.5)

DataD <- Alldata$data_D
DataP <- Alldata$data_P
theta <- Alldata$theta

DataD[1:250, 1] <- NA
DataD[251:500, 2] <- NA
DataP[501:750, 1] <- NA
DataP[751:1000, 2] <- NA
colnames(DataD) <- paste0("item", 1:10)
colnames(DataP) <- paste0("item", 1:5)
```


\
\
\

+ **Analysis** (parameter estimation)

```{r, results='hide', message=FALSE}
Mod1 <- IRTest_Mix(data_D = DataD,
                   data_P = DataP,
                   model_D = "2PL",
                   model_P = "GPCM",
                   latent_dist = "KDE")
```

\
\
\

+ **Results**

```{r, fig.align='center', fig.height=6, fig.width=6}
### Summary
summary(Mod1)

### The estimated item parameters
Mod1$par_est

### The asymptotic standard errors of item parameters
Mod1$se

### The estimated ability parameters
plot(theta, Mod1$theta)
abline(b=1, a=0)
```

* The result of latent distribution estimation

```{r, fig.align='center', fig.asp=.6, fig.width=6}
plot(Mod1, mapping = aes(colour="Estimated"), linewidth = 1) +
  lims(
    y = c(0, .75)
  )+
  geom_line(
    mapping=aes(
      x=seq(-6,6,length=121), 
      y=dist2(
        seq(-6,6,length=121),
        prob = .3, 
        d=1.664, 
        sd_ratio = 2
        ), 
      colour="True"),
    linewidth = 1)+
  labs(
    title="The estimated latent density using '2NM'", colour= "Type"
    )+
  theme_bw()
```


* Item response function

```{r, fig.align='center', fig.asp=0.8, fig.width=6}
p1 <- plot_item(Mod1,1, type="d")
p2 <- plot_item(Mod1,4, type="d")
p3 <- plot_item(Mod1,8, type="d")
p4 <- plot_item(Mod1,10, type="d")
grid.arrange(p1, p2, p3, p4, ncol=2, nrow=2)
```

```{r, fig.align='center', fig.asp=0.8, fig.width=6}
p1 <- plot_item(Mod1,1, type="p")
p2 <- plot_item(Mod1,2, type="p")
p3 <- plot_item(Mod1,3, type="p")
p4 <- plot_item(Mod1,4, type="p")
grid.arrange(p1, p2, p3, p4, ncol=2, nrow=2)
```



+ **Item fit**
```{r}
item_fit(Mod1)
```

* Reliability

```{r}
reliability(Mod1)
```

* Posterior distributions for the examinees

Each examinee's posterior distribution is identified in the E-step of the estimation algorithm (i.e., EM algorithm).
Posterior distributions can be found in `Mod1$Pk`.

```{r, fig.align='center', fig.asp=.7, fig.width=6}
set.seed(1)
selected_examinees <- sample(1:1000,6)
post_sample <- 
  data.frame(
    X = rep(seq(-6,6, length.out=121),6), 
    prior = rep(Mod1$Ak/(Mod1$quad[2]-Mod1$quad[1]), 6),
    posterior = 10*c(t(Mod1$Pk[selected_examinees,])), 
    ID = rep(paste("examinee", selected_examinees), each=121)
    )

ggplot(data=post_sample, mapping=aes(x=X))+
  geom_line(mapping=aes(y=posterior, group=ID, color='Posterior'))+
  geom_line(mapping=aes(y=prior, group=ID, color='Prior'))+
  labs(title="Posterior densities for selected examinees", x=expression(theta), y='density')+
  facet_wrap(~ID, ncol=2)+
  theme_bw()
```

* Test information function

```{r, fig.align='center', fig.asp=.8, fig.width=8}
ggplot()+
  stat_function(
    fun = inform_f_test,
    args = list(Mod1)
  )+ 
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est$Dichotomous, 1, "d"),
    mapping = aes(color="Dichotomous Item 1")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est$Dichotomous, 2, "d"),
    mapping = aes(color="Dichotomous Item 2")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est$Dichotomous, 3, "d"),
    mapping = aes(color="Dichotomous Item 3")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est$Polytomous, 1, "p"),
    mapping = aes(color="Polytomous Item 1")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est$Polytomous, 2, "p"),
    mapping = aes(color="Polytomous Item 2")
  )+
  stat_function(
    fun=inform_f_item,
    args = list(Mod1$par_est$Polytomous, 3, "p"),
    mapping = aes(color="Polytomous Item 3")
  )+
  lims(x=c(-6,6))+
  labs(title="Test information function", x=expression(theta), y='information')+
  theme_bw()
```

----

